{% extends "base_files/admin_base.html" %}
{% load static %}
{% block admin_content %}
<div class="content px-3">
    <div class="d-flex justify-content-between align-items-center py-3">
        <h2>User Management</h2>

        <!-- Delete Button (Initially Hidden) -->
        <button id="delete-selected" class="btn btn-danger" style="display: none;" onclick="deleteSelectedUsers()">
            Delete
        </button>
    </div>

    <form id="delete-form" method="post" action="{% url 'delete_users' %}">
        {% csrf_token %}
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th scope="col"><input type="checkbox" id="select-all" /></th>
                    <th scope="col">Name</th>
                    <th scope="col">Gender</th>
                    <th scope="col">Age</th>
                    <th scope="col">Location</th>
                    <th scope="col">Status</th>
                    <th scope="col">Subscription Type</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <input type="checkbox" class="user-checkbox" name="selected_users" value="{{ user.user.id }}" />
                    </td>
                    <td>
                        <img src="{{ user.profile_pic.url }}" class="rounded-circle me-2" width="30" height="30" alt="User Image">
                        {{ user.user.username }}
                    </td>
                    <td>{{ user.get_gender_display }}</td>
                    <td>{{ user.age }}</td>
                    <td>{{ user.user_location }}</td>
                    <td>
                        <select class="form-select form-select-sm status-select" data-user-id="{{ user.id }}">
                            <option {% if user.user.is_active == False %}selected{% endif %} value="0">Block</option>
                            <option {% if user.user.is_active == True %}selected{% endif %} value="1">Unblock</option>
                        </select>
                    </td>
                    <td>{{ user.subscription_type }}</td>
                    <td>
                        <a href="{% url 'edit_user' user.id %}" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal" data-user-id="{{ user.id }}">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
   

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock admin_content %}
<footer>
    {% block admin_footer %}
   <!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" method="post" action="{% url 'edit_user' 0 %}">
                    {% csrf_token %}
                    <!-- Render form fields without using template tags -->
                    <div class="mb-3">
                        <label for="username">Username:</label>
                        <input type="text" name="username" id="username" class="form-control" required value="{{ form.username.value|default_if_none:'' }}">
                    </div>
                    <div class="mb-3">
                        <label for="gender">Gender:</label>
                        <select name="gender" id="gender" class="form-select" required>
                            <option value="Male" {% if form.gender.value == 'Male' %}selected{% endif %}>Male</option>
                            <option value="Female" {% if form.gender.value == 'Female' %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="age">Age:</label>
                        <input type="number" name="age" id="age" class="form-control" required value="{{ form.age.value|default_if_none:'' }}">
                    </div>
                    <div class="mb-3">
                        <label for="location">Location:</label>
                        <input type="text" name="location" id="location" class="form-control" required value="{{ form.location.value|default_if_none:'' }}">
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
    {% endblock admin_footer %}
</footer>
{% block admin_scripts %}
 <!-- jQuery (required for jQuery-based methods) -->
 <script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
 <!-- Popper and Bootstrap JS -->
 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
 
 <!-- JavaScript for sidebar toggle and block confirmation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sidebar Toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('show');
        });
   
        // Confirmation for blocking/unblocking user
        const statusSelects = document.querySelectorAll('.status-select');
        statusSelects.forEach(select => {
            select.addEventListener('change', handleStatusChange);
        });
   
        // Handle status change for users
        function handleStatusChange() {
            const action = this.value === "0" ? "block" : "unblock";
            let reason = '';
   
            if (action === "block") {
                reason = prompt("Please provide a reason for blocking the user:");
                if (!reason) {
                    alert("Block reason is required.");
                    this.value = "1";  // Revert to Unblock
                    return;
                }
            }
   
            const confirmMessage = `Are you sure you want to ${action} this user?`;
            if (!confirm(confirmMessage)) {
                this.value = this.value === "0" ? "1" : "0";  // Revert the selection
                return;
            }
   
            const userId = this.getAttribute('data-user-id');
            const isActive = this.value === "1";
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
   
            // Send the block/unblock request with reason if applicable
            $.ajax({
                url: '{% url "block_unblock_user" %}',  // URL of the block/unblock view
                method: 'POST',
                data: {
                    userId: userId,
                    isActive: isActive,
                    blockReason: reason,
                    csrfmiddlewaretoken: csrfToken,  // Include CSRF token
                },
                success: function(response) {
                    alert('User status updated successfully.');
                },
                error: function(error) {
                    alert('Error updating user status.');
                }
            });
        }
   
        // Select/Deselect all checkboxes
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            toggleDeleteButton();
        });
   
        // Toggle delete button visibility based on checkbox selections
        document.querySelectorAll('.user-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', toggleDeleteButton);
        });
   
        // Function to toggle the delete button visibility
        function toggleDeleteButton() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const deleteButton = document.getElementById('delete-selected');
            deleteButton.style.display = selectedCheckboxes.length > 0 ? 'inline-block' : 'none';
        }
   
        // Function to delete selected users
        document.getElementById('delete-selected').addEventListener('click', function() {
            const form = document.getElementById('delete-form');
            if (confirm("Are you sure you want to delete the selected users?")) {
                form.submit();  // Submit the form for deletion
            }
        });
    });
    
        
</script>
</body>
</html>
{% endblock admin_scripts %}